.nolist
.includepath "/usr/share/avra"
.include "m48def.inc"
.list

.dseg

.cseg
RJMP	MAIN	; RESET
RETI		; INT0
RETI		; INT1
RETI		; PCINT0
RETI		; PCINT1
RETI		; PCINT2
RETI		; WDT
RETI		; T2COMPA
RETI		; T2COMPB
RETI		; T2OVF
RETI		; T1CAPT
RETI		; T1COMPA
RETI		; T1COMPB
RETI		; T1OVF
RJMP TIMER0	; T0COMPA
RETI		; T0COMPB
RETI		; T0OVF
RETI		; SPI
RETI		; RX
RETI		; UDRE
RETI		; TX
RETI		; ADC
RETI		; EEREADY
RETI		; ANALOG COMP
RETI		; TWI
RETI		; SPM

.def	PWM_U=R10
.def	PWM_V=R11
.def    PWM_W=R12

.equ	PH_U=0x0100
.equ	PH_V=0x0101
.equ	PH_W=0x0102

.equ	PH_VAL_H=0x01
.equ	PH_VAL_L=0x03
.equ	PH_NUM=36

.equ	AMPL=PH_VAL_L+PH_NUM+2+PH_VAL_H*0x100 ; amplitude
.equ	FREQ=PH_VAL_L+PH_NUM+1+PH_VAL_H*0x100 ; interval for timer

.equ	PWM_DELAY=20

TIMER0:
	LDI R20, 0
	OUT TCNT0, R20

	LDS R20, FREQ
	OUT OCR0A, R20

	LDS R20, PH_U
	INC R20
	CPI R20, PH_NUM
	BRLO T0NU
	CLR R20
T0NU:
	STS PH_U, R20

	LDS R20, PH_V
	INC R20
	CPI R20, PH_NUM
	BRLO T0NV
	CLR R20
T0NV:
	STS PH_V, R20

	LDS R20, PH_W
	INC R20
	CPI R20, PH_NUM
	BRLO T0NW
	CLR R20
T0NW:
	STS PH_W, R20

	LDS R3, AMPL

	LDI R21, PH_VAL_L
	LDI XH,  PH_VAL_H

	LDS XL, PH_U
	ADD XL, R21
	LD R2, X
	MUL R2, R3
	MOV PWM_U, R1

	LDS XL, PH_V
	ADD XL, R21
	LD R2, X
	MUL R2, R3
	MOV PWM_V, R1

	LDS XL, PH_W
	ADD XL, R21
	LD R2, X
	MUL R2, R3
	MOV PWM_W, R1
RETI

EEREAD:
	; R17:R16
	OUT EEARL, R16
	OUT EEARH, R17
	SBI EECR, EERE	
	IN R16, EEDR
	RET

SET_TIMER:
	LDI R16, 0b00000000
	OUT TCCR0A, R16

	; prescale /256
	LDI R16, 0b00000100
	OUT TCCR0B, R16

	LDI R16, 0b00000010
	STS TIMSK0, R16

	LDI R16, PH_NUM+1
	LDI R17, 0
	CALL EEREAD
	STS FREQ, R16
	OUT OCR0A, R16
RET

SET_PH_VAL:
	CLR R21

	LDI R17, 0

	LDI XH, PH_VAL_H
	LDI XL, PH_VAL_L
SPVL:
	MOV R16, R21
	CALL EEREAD

	ST X+, R16
	INC R21
	CPI R21, PH_NUM
	BRLO SPVL

	LDI R21, 0
	STS PH_U, R21
	LDI R21, PH_NUM/3
	STS PH_V, R21
	LDI R21, 2*PH_NUM/3
	STS PH_W, R21
	
RET

; R1:R0 - delay time
SLEEP:
	DEC R0
	BRNE SLEEP
	
	LDI R16, 255
	MOV R0, R16
	
	DEC R1
	BRNE SLEEP	
RET


FLTCLR:
	LDI R16, 0b11111111
	OUT PORTD, R16

	LDI R16, 0
	MOV R0, R16
	LDI R17, 3
	MOV R1, R16
	CALL SLEEP

	LDI R16, 0b00011111
	OUT PORTD, R16

	LDI R16, 0
	MOV R0, R16
	LDI R17, 3
	MOV R1, R16
	CALL SLEEP

	LDI R16, 0b11111111
	OUT PORTD, R16

	LDI R16, 0
	MOV R0, R16
	LDI R17, 3
	MOV R1, R16
	CALL SLEEP
RET

MAIN:
	LDI R16, 0b00000011
	OUT DDRC, R16

	LDI R16, 0b00000000
	OUT PORTC, R16

	LDI R16, 0b11111111
	OUT DDRD, R16

	CALL FLTCLR
	
	LDI R16, 0b11100011
	OUT PORTD, R16

RJMP END

	LDI R18, 0
	MOV PWM_U, R18

	LDI R18, 0
	MOV PWM_V, R18

	LDI R18, 0
	MOV PWM_W, R18

	LDI R16, 0x00
	OUT PORTD, R16
	

	LDI R16, PH_NUM
	LDI R17, 0
	CALL EEREAD
	STS AMPL, R16

	CALL SET_PH_VAL
	CALL SET_TIMER

	LDI R16, 0xFF
	MOV R5, R16

	SEI
	LOOP:

		CLR R16
		OUT PORTD, R16
		CLR R18
		DELAY2:
			INC R18
			CPI R18, PWM_DELAY
			BRLO DELAY2

		LDI R16, 0b00011100
		OUT PORTD, R16

		CLR R19

		CLR R17
		PWMLOOP:
			OR  R16, R19
			CLR R19
		
			PWM1:
				CP  R17, PWM_U
				BRNE PWM2
				ANDI R16, 0b11111011
				ORI  R19, 0b00100000
			PWM2:
				CP  R17, PWM_V
				BRNE PWM3
				ANDI R16, 0b11110111
				ORI  R19, 0b01000000
			PWM3:
				CP  R17, PWM_W
				BRNE PWMEND
				ANDI R16, 0b11101111
				ORI  R19, 0b10000000
			PWMEND:
		
			MOV R4, R16
			EOR R4, R5	
			OUT PORTD, R4
			
			CLR R18
			DELAY:
				INC R18
				CPI R18, PWM_DELAY
				BRLO DELAY
			INC R17
			CPI R17, 0
		BRNE PWMLOOP

	RJMP LOOP

	END:
	NOP
	RJMP END

